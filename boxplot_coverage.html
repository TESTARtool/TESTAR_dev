<!doctype html>
<body>
<input type="file" id="fileInput" name="filefield" multiple="multiple">
maxIns:<textarea id="maxIns"></textarea>
minIns:<textarea id="minIns"></textarea>
maxBra:<textarea id="maxBra"></textarea>
minBra:<textarea id="minBra"></textarea>
<div id="fileDisplayArea" style="width: 400px; height: 50px;"></div>
<div id="covInstContainer" style="width: 500px; height: 400px;"></div>
<div id="covBranContainer" style="width: 500px; height: 400px;"></div>
<script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js" type="text/javascript"></script>
<script>
// https://jsfiddle.net/b1ynb405/
var fileInput = document.getElementById('fileInput');
var fileDisplayArea = document.getElementById('fileDisplayArea');

fileInput.addEventListener('change', function(e) {
    const coverageFiles = fileInput.files;

    // Validate we are reading txt files
    for (var i = 0; i < coverageFiles.length; i++){
        var textType = /text.*/;
        if(!coverageFiles[i].type.match(textType)){
            fileDisplayArea.innerText = "Some text coverageFile is not supported!"
            throw new Error('Some text coverageFile is not supported!');
        }
    }
	
    myfunction(coverageFiles);
});

async function myfunction(coverageFiles) {
	const allDataInst = [];
	const allDataBran = [];
	
	//create a box plot chart
	var chartInst = anychart.box();
	var chartBran = anychart.box();
	
	// set max and min box plot values if user indicates it
	var maxIns = document.getElementById("maxIns") === null ? "" : document.getElementById("maxIns").value;
	if(!isEmpty(maxIns) && !isNaN(parseInt(maxIns))) chartInst.yScale().maximum(parseInt(maxIns));
	
	var minIns = document.getElementById("minIns") === null ? "" : document.getElementById("minIns").value;
	if(!isEmpty(minIns) && !isNaN(parseInt(minIns))) chartInst.yScale().minimum(parseInt(minIns));
	
	var maxBra = document.getElementById("maxBra") === null ? "" : document.getElementById("maxBra").value;
	if(!isEmpty(maxBra) && !isNaN(parseInt(maxBra))) chartBran.yScale().maximum(parseInt(maxBra));
	
	var minBra = document.getElementById("minBra") === null ? "" : document.getElementById("minBra").value;
	if(!isEmpty(minBra) && !isNaN(parseInt(minBra))) chartBran.yScale().minimum(parseInt(minBra));
    
	chartInst.title("Instruction Coverage");
	chartBran.title("Branch Coverage");

    /*for (var i = 0; i < coverageFiles.length; i++){
        const fileReader = new SyncFileReader(coverageFiles[i]);
        const arrayBuffer = await fileReader.readAsText();
		// Coverage metrics created with Windows CR LF
        var arrLines = arrayBuffer.split("\r\n");
        for (var line = 0; line < arrLines.length; line++) {
		    // Skip empty line, usually at the end of the file
			if(isEmpty(arrLines[line])) continue;
			// Time | 2021_09_13_11_28_33 | Missed Instructions | 16,305 of 18,288 | Cov | 10,84 | Missed Branches | 1,167 of 1,214 | Cov | 3,87 | Missed | 1,465 | Cxty | 1,738 | Missed | 3,610 | Lines | 4,184 | Missed | 864 | Methods | 1,127 | Missed | 67 | Classes | 153
			allDataInst.push( parseFloat( arrLines[line].split(" | ")[5].replace(",",".") ) );
			allDataBran.push( parseFloat( arrLines[line].split(" | ")[9].replace(",",".") ) );
        }
        console.log(coverageFiles[i].name);
	}*/
    for (var i = 0; i < coverageFiles.length; i++){
        const fileReader = new SyncFileReader(coverageFiles[i]);
        const arrayBuffer = await fileReader.readAsText();
		// Coverage metrics created with Windows CR LF
        var arrLines = arrayBuffer.split("\r\n");
		// Each 5 seconds 1 coverage line, 12 lines per second, 120 lines = 10 minutes 
		var line = 120;
		//var line = 240;
		// Time | 2021_09_13_11_28_33 | Missed Instructions | 16,305 of 18,288 | Cov | 10,84 | Missed Branches | 1,167 of 1,214 | Cov | 3,87 | Missed | 1,465 | Cxty | 1,738 | Missed | 3,610 | Lines | 4,184 | Missed | 864 | Methods | 1,127 | Missed | 67 | Classes | 153
		allDataInst.push( parseFloat( arrLines[line].split(" | ")[5].replace(",",".") ) );
		allDataBran.push( parseFloat( arrLines[line].split(" | ")[9].replace(",",".") ) );
        console.log(coverageFiles[i].name);
	}
	console.log(allDataInst)
	console.log(getBoxValues(allDataInst))
	chartInst.box(getBoxValues(allDataInst));
	chartBran.box(getBoxValues(allDataBran));

	//set the container where chart will be drawn
	chartInst.container("covInstContainer");
	chartBran.container("covBranContainer");

	// Enable legend colours
	chartInst.legend().enabled(true)
	chartBran.legend().enabled(true)

	//draw the chart on the page
	chartInst.draw();
	chartBran.draw();
	console.log('finish drawing stuff');
}

// https://stackoverflow.com/a/30896483
// http://jsfiddle.net/jlbriggs/db11fots/
//wrap the percentile calls in one method
function getBoxValues(data) {
	const totalBoxData = [];
	const outliers = [];
	var boxData = {},
	min = Math.min.apply(Math, data),
	max = Math.max.apply(Math, data),
	q1 = getPercentile(data, 25),
	median = getPercentile(data, 50),
	q3 = getPercentile(data, 75),
	iqr = q3 - q1,
	lowerFence = q1 - (iqr * 1.5),
	upperFence = q3 + (iqr * 1.5);

	for (var i = 0; i < data.length; i++) {
		if (data[i] < lowerFence || data[i] > upperFence) {
			outliers.push(data[i]);
		}
	}
	boxData = {};
	boxData.low = lowerFence;
	boxData.q1 = q1;
	boxData.median = median;
	boxData.q3 = q3;
	boxData.high = upperFence;
	boxData.outliers = outliers;
	totalBoxData.push(boxData);

	return totalBoxData;
}
//get any percentile from an array
function getPercentile(data, percentile) {
  data.sort(numSort);
  var index = (percentile / 100) * data.length;
  var result;
  if (Math.floor(index) == index) {
    result = (data[(index - 1)] + data[index]) / 2;
  } else {
    result = data[Math.floor(index)];
  }
  return result;
}
//because .sort() doesn't sort numbers correctly
function numSort(a, b) {
  return a - b;
}

function SyncFileReader(file) {
    let self = this;
    let ready = false;
    let result = '';

    const sleep = function (ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    self.readAsText = async function() {
        while (ready === false) {
          await sleep(100);
        }
        return result;
    }    

    const reader = new FileReader();
    reader.onloadend = function(evt) {
        result = evt.target.result;
        ready = true;
    };
    reader.readAsText(file);
}

function isEmpty(str) {
    return (!str || str.length === 0 );
}
</script>
</body>
</html>